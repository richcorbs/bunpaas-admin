---
layout: raw
---

<!doctype html>
<html lang="en" class="theme-dark" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RichHost Admin</title>
    <link rel="stylesheet" href="/assets/rico.css" />
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  </head>
  <body x-data="adminApp()">
    <nav class="container">
      <div class="brand">
        <a href="/">RichHost Admin</a>
      </div>
      <ul>
        <li><a href="https://paas.richcorbs.com">Platform</a></li>
      </ul>
    </nav>

    <main class="container pt-16">
      <!-- Sites List -->
      <section>
        <div class="flex justify-between items-center mb-6">
          <h1>Sites</h1>
          <button @click="$refs.addSiteDialog.showModal()" class="btn">Add Site</button>
        </div>

        <div x-show="loading" class="text-center py-8">
          <p class="text-muted">Loading sites...</p>
        </div>

        <div x-show="!loading && sites.length === 0" class="text-center py-8">
          <p class="text-muted">No sites yet. Add your first site to get started.</p>
        </div>

        <template x-for="site in sites" :key="site.host">
          <article class="flex justify-between items-center p-4 mb-4">
            <div class="flex-1">
              <div class="fw-bold fs-lg" x-text="site.host"></div>
              <div class="text-muted fs-sm flex gap-4 items-center">
                <span x-show="site.enabled" class="inline-block px-2 py-1 rounded-full fs-sm fw-bold bg-success text-success">Enabled</span>
                <span x-show="!site.enabled" class="inline-block px-2 py-1 rounded-full fs-sm fw-bold bg-warning text-warning">Disabled</span>
                <template x-if="site.lastDeploy">
                  <span>
                    <span x-text="formatDate(site.lastDeploy)"></span>
                    <span x-show="getLatestStats(site)"> â€¢ </span>
                    <span x-show="getLatestStats(site)" x-text="getLatestStats(site)"></span>
                  </span>
                </template>
                <span x-show="!site.lastDeploy" class="text-muted">Never deployed</span>
              </div>
            </div>
            <div class="flex gap-2">
              <button @click="editSite(site)" class="btn btn-secondary btn-sm">Edit</button>
              <button @click="toggleSite(site)" class="btn btn-ghost btn-sm" x-text="site.enabled ? 'Disable' : 'Enable'"></button>
            </div>
          </article>
        </template>
      </section>
    </main>

    <!-- Add Site Modal -->
    <dialog x-ref="addSiteDialog" @close="showAddSite = false">
      <article>
        <h2 class="mb-4">Add New Site</h2>
        <form @submit.prevent="addSite">
          <label>
            Domain
            <input type="text" x-model="newSite.host" placeholder="www.example.com" required />
          </label>
          <p class="text-muted fs-sm mb-4">The domain should point to this server's IP address.</p>
          <div class="flex gap-2 justify-end">
            <button type="button" @click="$refs.addSiteDialog.close()" class="btn btn-secondary">Cancel</button>
            <button type="submit" class="btn" :disabled="addingSite">
              <span x-show="!addingSite">Add Site</span>
              <span x-show="addingSite">Adding...</span>
            </button>
          </div>
        </form>
      </article>
    </dialog>

    <!-- Edit Site Modal -->
    <dialog x-ref="editSiteDialog" @close="showEditSite = false">
      <article style="width: 90vw; max-width: 700px">
        <h2 class="mb-4" x-text="editingSite?.host"></h2>

        <!-- Tabs -->
        <div class="flex gap-2 mb-2">
          <button @click="editTab = 'env'" class="btn btn-sm rounded-full" :class="editTab === 'env' ? '' : 'btn-ghost'">Environment</button>
          <button @click="editTab = 'deploys'" class="btn btn-sm rounded-full" :class="editTab === 'deploys' ? '' : 'btn-ghost'">Deploys</button>
          <button @click="editTab = 'logs'; loadLogs(editingSite.host)" class="btn btn-sm rounded-full" :class="editTab === 'logs' ? '' : 'btn-ghost'">Logs</button>
          <button @click="editTab = 'danger'" class="btn btn-sm rounded-full" :class="editTab === 'danger' ? '' : 'btn-ghost'">Danger</button>
        </div>

        <!-- Environment Variables -->
        <div x-show="editTab === 'env'">
          <h3 class="mb-2">Environment Variables</h3>
          <template x-for="(value, key, index) in editingSite?.env || {}" :key="key">
            <div class="flex gap-2 mb-2">
              <input type="text" :value="key" disabled class="flex-1" />
              <input type="password" x-model="editingSite.env[key]" @focus="$event.target.type='text'" @blur="$event.target.type='password'" class="flex-1" />
              <button type="button" @click="removeEnvVar(key)" class="btn btn-ghost btn-sm fs-xl">&times;</button>
            </div>
          </template>
          <div class="flex gap-2 mb-2">
            <input type="text" x-model="newEnvKey" placeholder="KEY" class="flex-1" />
            <input type="text" x-model="newEnvValue" placeholder="value" class="flex-1" />
            <button type="button" @click="addEnvVar" class="btn btn-secondary btn-sm fs-xl">&plus;</button>
          </div>
          <div class="flex justify-end mt-4">
            <button @click="saveEnvVars" class="btn">Save Environment</button>
          </div>
        </div>

        <!-- Deploys -->
        <div x-show="editTab === 'deploys'">
          <h3 class="mb-2">Recent Deploys</h3>
          <div x-show="deploys.length === 0" class="text-muted">No deploys yet.</div>
          <template x-for="deploy in deploys" :key="deploy.timestamp">
            <div class="flex justify-between items-center py-2 border-b">
              <div>
                <span x-text="formatDate(deploy.timestamp)"></span>
                <span x-show="deploy.current" class="inline-block ml-2 px-2 py-1 rounded-full fs-sm fw-bold bg-brand text-primary">Current</span>
              </div>
              <button x-show="!deploy.current && deploy.canRollback" @click="rollback(deploy.timestamp)" class="btn btn-outline btn-sm">Rollback</button>
            </div>
          </template>
          <p class="text-muted fs-sm mt-4">Deploy Key: <code x-text="editingSite?.deployKey"></code></p>
        </div>

        <!-- Logs -->
        <div x-show="editTab === 'logs'">
          <h3 class="mb-2">Recent Requests</h3>
          <div x-show="logs.length === 0" class="text-muted">No requests logged yet.</div>
          <div class="fs-sm" style="max-height: 400px; overflow-y: auto">
            <template x-for="(log, i) in logs" :key="i">
              <div class="flex gap-4 py-1 border-b">
                <span class="text-muted" style="min-width: 140px" x-text="formatDate(log.timestamp)"></span>
                <span :class="log.status >= 400 ? 'text-danger' : 'text-success'" style="min-width: 30px" x-text="log.status"></span>
                <span x-text="log.method" style="min-width: 40px"></span>
                <span class="flex-1" x-text="log.path"></span>
              </div>
            </template>
          </div>
        </div>

        <!-- Danger Zone -->
        <div x-show="editTab === 'danger'">
          <h3 class="mb-2 text-danger">Danger Zone</h3>
          <p class="text-muted mb-4">Deleting a site will remove it from the platform. The files will remain on disk.</p>
          <button @click="confirmDelete" class="btn bg-danger">Delete Site</button>
        </div>

        <div class="flex justify-end mt-4">
          <button @click="$refs.editSiteDialog.close()" class="btn btn-secondary">Close</button>
        </div>
      </article>
    </dialog>

    <script>
      function adminApp() {
        return {
          loading: true,
          sites: [],
          showAddSite: false,
          showEditSite: false,
          newSite: { host: "" },
          addingSite: false,
          editingSite: null,
          editTab: "env",
          deploys: [],
          logs: [],
          newEnvKey: "",
          newEnvValue: "",
          apiKey: null,

          async init() {
            try {
              const res = await fetch("/auth");
              if (res.ok) {
                const data = await res.json();
                this.apiKey = data.apiKey;
              }
            } catch (err) {
              console.error("Auth failed:", err);
            }
            await this.loadSites();
          },

          async loadSites() {
            this.loading = true;
            try {
              const res = await fetch("/sites", {
                headers: { "X-API-Key": this.apiKey },
              });
              if (res.ok) {
                const data = await res.json();
                this.sites = Object.entries(data).map(([host, site]) => ({ host, ...site }));
              }
            } catch (err) {
              console.error("Failed to load sites:", err);
            }
            this.loading = false;
          },

          async addSite() {
            this.addingSite = true;
            try {
              const res = await fetch("/sites/" + encodeURIComponent(this.newSite.host), {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                  "X-API-Key": this.apiKey,
                },
                body: JSON.stringify({ enabled: true, env: {} }),
              });
              if (res.ok) {
                this.$refs.addSiteDialog.close();
                this.newSite = { host: "" };
                await this.loadSites();
              } else {
                const data = await res.json();
                alert(data.error || "Failed to add site");
              }
            } catch (err) {
              console.error("Failed to add site:", err);
              alert("Failed to add site");
            }
            this.addingSite = false;
          },

          async editSite(site) {
            this.editingSite = { ...site, env: { ...site.env } };
            this.editTab = "env";
            this.$refs.editSiteDialog.showModal();
            await this.loadDeploys(site.host);
          },

          async loadDeploys(host) {
            try {
              const res = await fetch("/sites/" + encodeURIComponent(host) + "/deploys", {
                headers: { "X-API-Key": this.apiKey },
              });
              if (res.ok) {
                this.deploys = await res.json();
              }
            } catch (err) {
              console.error("Failed to load deploys:", err);
              this.deploys = [];
            }
          },

          async loadLogs(host) {
            try {
              const res = await fetch("/sites/" + encodeURIComponent(host) + "/logs", {
                headers: { "X-API-Key": this.apiKey },
              });
              if (res.ok) {
                this.logs = await res.json();
              }
            } catch (err) {
              console.error("Failed to load logs:", err);
              this.logs = [];
            }
          },

          async toggleSite(site) {
            try {
              const res = await fetch("/sites/" + encodeURIComponent(site.host), {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                  "X-API-Key": this.apiKey,
                },
                body: JSON.stringify({ enabled: !site.enabled }),
              });
              if (res.ok) {
                await this.loadSites();
              }
            } catch (err) {
              console.error("Failed to toggle site:", err);
            }
          },

          addEnvVar() {
            if (this.newEnvKey && this.newEnvValue) {
              this.editingSite.env[this.newEnvKey] = this.newEnvValue;
              this.newEnvKey = "";
              this.newEnvValue = "";
            }
          },

          removeEnvVar(key) {
            delete this.editingSite.env[key];
            this.editingSite = { ...this.editingSite };
          },

          async saveEnvVars() {
            try {
              const res = await fetch("/sites/" + encodeURIComponent(this.editingSite.host) + "/env", {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                  "X-API-Key": this.apiKey,
                },
                body: JSON.stringify(this.editingSite.env),
              });
              if (res.ok) {
                alert("Environment variables saved");
                await this.loadSites();
              }
            } catch (err) {
              console.error("Failed to save env:", err);
              alert("Failed to save environment variables");
            }
          },

          async rollback(timestamp) {
            if (!confirm("Rollback to deploy from " + this.formatDate(timestamp) + "?")) return;
            try {
              const res = await fetch("/sites/" + encodeURIComponent(this.editingSite.host) + "/rollback", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "X-API-Key": this.apiKey,
                },
                body: JSON.stringify({ deploy: timestamp }),
              });
              if (res.ok) {
                alert("Rollback successful");
                await this.loadDeploys(this.editingSite.host);
              }
            } catch (err) {
              console.error("Rollback failed:", err);
              alert("Rollback failed");
            }
          },

          async confirmDelete() {
            if (!confirm("Are you sure you want to delete " + this.editingSite.host + "?")) return;
            if (!confirm("This action cannot be undone. Continue?")) return;
            try {
              const res = await fetch("/sites/" + encodeURIComponent(this.editingSite.host), {
                method: "DELETE",
                headers: { "X-API-Key": this.apiKey },
              });
              if (res.ok) {
                this.$refs.editSiteDialog.close();
                await this.loadSites();
              }
            } catch (err) {
              console.error("Delete failed:", err);
              alert("Delete failed");
            }
          },

          formatDate(dateStr) {
            if (!dateStr) return "";
            const d = new Date(dateStr);
            return d.toLocaleDateString() + " " + d.toLocaleTimeString();
          },

          formatSize(bytes) {
            if (bytes < 1024) return bytes + " B";
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
            return (bytes / (1024 * 1024)).toFixed(1) + " MB";
          },

          getLatestStats(site) {
            const history = site.deployHistory;
            if (!history || !history.length) return null;
            const latest = history[0];
            if (typeof latest === "string" || !latest.files) return null;
            return `${latest.files} files, ${this.formatSize(latest.size)}`;
          },
        };
      }
    </script>
  </body>
</html>
